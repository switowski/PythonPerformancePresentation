<!doctype html>
<html lang="en">

	<head>
		<meta charset="utf-8">

		<title>How to write faster Python ?</title>

		<meta name="description" content="Presentation about faster Python">
		<meta name="author" content="Sebastian Witowski">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

		<link rel="stylesheet" href="css/custom.css">
		<link rel="stylesheet" href="css/reveal.css">
		<link rel="stylesheet" href="css/theme/black.css" id="theme">

		<!-- Code syntax highlighting -->
		<link rel="stylesheet" href="lib/css/zenburn.css">

		<!-- Printing and PDF exports -->
		<script>
			var link = document.createElement( 'link' );
			link.rel = 'stylesheet';
			link.type = 'text/css';
			link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
			document.getElementsByTagName( 'head' )[0].appendChild( link );
		</script>

		<!--[if lt IE 9]>
		<script src="lib/js/html5shiv.js"></script>
		<![endif]-->
	</head>
	<body>
		<div class="reveal">
			<div class="slides">
				<section data-markdown>
					<script type="text/template">
						# Maybe it's not Python that sucks
						## Maybe it's my code
						<br>
						<br>
						<br>
						<br>
						Sebastian Witowski

						Note:
						Hi guys, before we start - a quick question. How many of you are programming in Python ?
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
						<img data-src="./img/zen.png">

						Note:
						Cool, so I guess quite a lot of you are familiar with "The Zen of Python" saying that there should be only one way to do something.
						However, if you come from a different language this "one" way might not be so "obvious".
						Sometimes there can be a huge performance gap between two programming structures that are producing the same results.
						More often, the performance difference won't be that huge, but if you have many small improvements they will add up.'
					</script>
				</section>
				<section>
					<h2>How to benchmark ?</h2>
					<p>
						Start REPL:
						<pre><code class='python'>$ ipython</code></pre>
					</p>
					<p>
						Write a function:
<pre><code class='python'>def powers(elements):
    arr = []
    for i in elements:
    	arr.append(i*i)
</code></pre>
					</p>
					<p>
						%timeit:
						<pre><code class='python'>%timeit test(range(1, 1 000 000))</code></pre>
					</p>
					<p>
						Et voilà:
						<pre><code class='python'>100 000 000 loops, best of 3: 93.1 ms per loop</code></pre>
					</p>

					<aside class="notes">
						So I'm gonna show you different ways to code some common programming structures along with the benchmarks.
						Benchmark numbers are not important. What is important is how easily you can get some speed improvements.
					</aside>
				</section>
				<section>
						<h4>#1 Counting the number of elements in list</h4>
						<div class='fragment'>
							<pre><code class='python'>def slow_list_count(array):
    how_many = 0
    for element in array:
        how_many += 1
    return how_many</pre></code>
						</div>
						<div class='fragment'>
							<pre><code class='python'>def faster_list_count(array):
    return len(array)</pre></code>
						</div>
							<p class='fragment'>For 1 000 000 elements it's <span class="bad">26.5 ms</span> vs <span class="good">96.7 ns</span>
							<img data-src="./img/over9000.jpg"><br />
							(<span class="good">274 000</span> times faster actually)</p>
						<aside class="notes">
						Let's start with something simple.
						Let's say you want to count the number of elements in a list. $$ You can easily write you own function, that contains just a for loop that increments a variable.
						There is nothing wrong with this code, except that it's slow. $$ You can achieve the same result using the built-in len() function. Any difference ?
						$$ Yes, the second function is way faster.
						So, try to use the built-in functions when you can. There is just a handful of them, so it's not so hard to remember the most useful ones.
						</aside>
				</section>
				<section data-markdown>
					<script type="text/template">
						#### #2 Filter list
						```python
						def filter_list_slow(array):
							output = []
							for element in array:
								if element % 2:
									output.append(element)
							return output

						```
						<p><span class="bad">70 ms</span></p>
						<div class='fragment'>
						<pre><code class='python'>def filter_list_faster(array):
							return filter(lambda x: x % 2, array)</pre></code>
						</div>
						<p class='fragment'><span class="bad">88.3 ms</span></p>

						Note:
						Let's say you want to filter a list of numbers and select only the odd ones.
						You can again write a simple function with a loop.
						But I told you before that you can write faster code if you use the built-in functions so you go to the Python manual and find a filter() function there.
						You also find information about lambdas because lambdas are hip.
						$$ So you rewrite your function using filter with a simple lambda inside.
						$$ Aaand it's slower.
						So, is there any way to make it faster than with an ugly loop ?
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
						#### #2 Filter list faster !
						```python
						def filter_list_comprehension(array):
							return [item for item in array if item % 2]
						```
						<p><span class="good">54.2 ms</span><br/>
						<span class="good">30%</span> faster than first version<br />
						<span class="good">60%</span> faster than the filter() version</p>

						Note:
						Yes, you can use list comprehension for that. It's faster and (at least for me) it looks better.'
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
						#### #3 Finding the first element matching the criteria
						List comprehension approach - slow and inefficient
						```python
						def find_min(array, min_val):
							return [i for i in array if i > min_val][0]

						```
						```python
						find_min(range(1, 1 000 000), 50 000)
						```
						<p><span class="bad">36.5 ms</span></p>

						Note:
						Let say you have a list and you want to find the first element bigger than some number.
						Using a list comprehension might sound like a pythonic solution but it is not very efficient,
						because it will iterate over the whole list and we don't need that.'
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
						#### #3 Finding the first element matching the criteria
						Loop with break - faster and efficient
						```python
						def find_x_loop(arr, min_val):
							for element in arr:
								if element > min_val:
									return element
						```
						```python
						find_min(range(1, 1 000 000), 50 000)
						```
						<p><span class="good">892 µs</span>(40 times faster)</p>

						```python
						find_min(range(1, 1 000 000), 500 000)
						```

						<p><span class="good">10.5 ms</span>(3 times faster)</p>

						Note:
						We can use the loop instead - it might not sound pythonic and fun at all, but it's faster and we don't spend time on useless computations.
						So, as you can see, not always the fancy pythonic solution is the best solution.
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
						#### #3 Finding the first element matching the criteria
						And then there is generator
						```python
						next(item for item in array if item > 50 000)
						```
						<p><span class="good">888 µs</span> - the same performance as loop</p>
						<div class='fragment'>
						<p>But !
						```python
						gen = (item for item in array if item > 50 000)
						next(gen) # => 50001
						next(gen) # => 50002
						```
						</p>
						</div>
						Note:
						Nah, I'm just kidding. Of course there is a more pythonic solution than that - a generator.
						$$ It has the same speed performance as loop, but if you want to get more than one element you get them instantly.'
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
						#### #4 Check if element is in a list
						```python
def in_array(array, element):
    for el in array:
        if el == element:
            return True
    return False
						```
						```python
in_array(range(1, 1 000 000), 123 456)
						```
						<p><span class="bad">2.59 ms</span></p>
						<div class='fragment'>
						```python
def in_array_index(array, element):
	try:
		array.index(element)
		return True
	except ValueError:
		return False
						```
						```python
in_array_index(range(1, 1 000 000), 123 456)
						```
						<p><span class="good">1.33 ms</span> (almost 2 times faster)</p>
						</div>
						Note:
						Let say you want to check if an element belongs to a list.
						Most of you know that using this loop is not the best solution
						$$
						You can instead use the index function together with some exception handling.
						It is faster and more pythonic because it is using one of the fundamental python rules: "ask for forgiveness, not for permission".
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
						#### #4 Check if element is in a list
						```python
123456 in range(1, 1 000 000)
						```
						<p><span class="good">1.08 ms</span> (more than 2 times faster)</p>
						</div>
						Note:
						But you can simplify your code to just one line using the "in" operator.
						It is even faster and simpler.
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
						#### #4 Check if element is in a list
						```python
ARR = range(1,1 000 000)

1 in ARR and 100 000 in ARR and 500 000 in ARR
						```
						<p><span class="bad">5.57 ms</span></p>
						<div class='fragment'>
						```python
S = set(ARR)

1 in S and 100 000 in S and 500 000 in S
						```
						<p><span class="good">165 ns</span> (33 000 times faster)<br/ >
						<img data-src="./img/over9000_cat.jpg">
						</p>
						</div>
						Note:
						If you are checking for a list membership often, then you might be interested in converting your list to a set ...
						$$ Because the lookup time inside a set is constant
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
						#### #5 Remove duplicates
						```python
						def remove_duplicates(array):
							unique = []
							for element in array:
								if element not in unique:
									unique.append(element)
							return unique
						```
						```python
# 100 000 elements with duplicates:
ARRAY = range(1,10 001) * 10

remove_duplicates(ARRAY)
						```
						<p><span class="bad">3.27 s</span></p>
						<div class='fragment'>
						```python
set(ARRAY)
						```
						<p><span class="good">1.12 ms</span> (almost 3 000 times faster)</p>
						</div>
						Note:
						Speaking of sets, they have some other cool features.
						$$ By default, they remove duplicates from a collection of items.
					</script>
				</section>
				<section data-markdown data-background="./img/over5000000.jpg">
					<script type="text/template">
						#### #6 Check if one list contain another
						```python
def check_if_subset(big_array, small_array):
	for element in small_array:
		if element not in big_array:
			return False
	return True
						```
						```python
ARRAY = range(1,1 000 000)
SMALL_ARRAY = range(1,10 000)

check_if_subset(ARR, SMALL_ARR)
						```
						<p class="with-background"><span class="bad">316 ms</span></p>
						```python
A_SET = set(range(1,1 000 000))
SMALL_SET = set(range(1,10 000))

SMALL_SET.issubset(A_SET)
						```
						<p class="with-background"><span class="good">60.3 ns</span> (5 000 000 times faster)<br />
						Note:
						 They also have a lot of functions that you can use to check for union, intersection or difference, so please don't use loops for that.
						 For example, to check if one set is a subset of another one, you can use the issubset function, which is faster and more concise.'
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
						#### Take-away

						Note:
						So, to sum up:
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
						Think when you are coding (be curious)

						Note:
						Always be curious when you are programming, especially if you have moved to a new language. The same structure that was super-fast in one language might not work so well anymore.
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
						%timeit is your friend
						```python
						# python
						%timeit your_function
						```
						vs.
						```java
						// java (no mocking intended)
						long start = System.nanoTime();
						your_function();
						long elapsedTime = System.nanoTime() - start;
						System.out.println(elapsedTime/1000000);
						```

						Note:
						When in doubts - use timeit. It's just one line of code if you are using IPython (and you should be using IPython)'.
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
						Sometimes a good algorithm or data structure is the best optimization

						Note:
						And before you start thinking about changing the interpreter to squize additional 10% of speed improvement, make sure that your code is fine.
					</script>
				</section>
				<section data-markdown>
					<script type="text/template">
						## Thank you
						![](./img/get_over_9000.jpg)

						You liked it ? Let me know (there can be more).
					</script>
				</section>
			</div>
		</div>

		<script src="lib/js/head.min.js"></script>
		<script src="js/reveal.js"></script>
		<script>

			// Full list of configuration options available at:
			// https://github.com/hakimel/reveal.js#configuration
			Reveal.initialize({
				controls: false,
				progress: true,
				history: true,
				center: true,

				transition: 'slide', // none/fade/slide/convex/concave/zoom

				// Optional reveal.js plugins
				dependencies: [
					{ src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
					{ src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
					{ src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
					{ src: 'plugin/zoom-js/zoom.js', async: true },
					{ src: 'plugin/notes/notes.js', async: true }
				]
			});

		</script>

	</body>
</html>
